"""Vulnerability engine for risk scoring and prioritization."""

from typing import Any, Dict, List, Optional
from dataclasses import dataclass
from enum import Enum


class RiskLevel(Enum):
    """Risk level classification."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


@dataclass
class VulnerabilityScore:
    """Comprehensive vulnerability score."""
    cve_id: str
    base_score: float  # 0-10
    exploitability_score: float  # 0-10
    impact_score: float  # 0-10
    priority_score: float  # 0-100
    risk_level: RiskLevel
    factors: Dict[str, Any]


class VulnerabilityEngine:
    """Engine for vulnerability analysis, scoring, and prioritization."""

    def __init__(self, config: Optional[Dict[str, Any]] = None):
        self.config = config or {}
        self.scoring_weights = config.get("scoring_weights", {
            "cvss": 0.35,
            "epss": 0.25,
            "exploit_available": 0.20,
            "service_exposure": 0.10,
            "age": 0.10,
        }) if config else {
            "cvss": 0.35,
            "epss": 0.25,
            "exploit_available": 0.20,
            "service_exposure": 0.10,
            "age": 0.10,
        }

    def analyze_vulnerabilities(
        self,
        vulnerabilities: List[Dict[str, Any]],
        context: Optional[Dict[str, Any]] = None
    ) -> List[Dict[str, Any]]:
        """Analyze and score vulnerabilities."""
        scored_vulns = []

        for vuln in vulnerabilities:
            score = self.calculate_priority_score(vuln, context)
            vuln["priority_score"] = score.priority_score
            vuln["risk_level"] = score.risk_level.value
            vuln["scoring_factors"] = score.factors
            scored_vulns.append(vuln)

        # Sort by priority score (descending)
        scored_vulns.sort(key=lambda v: v.get("priority_score", 0), reverse=True)

        return scored_vulns

    def calculate_priority_score(
        self,
        vuln: Dict[str, Any],
        context: Optional[Dict[str, Any]] = None
    ) -> VulnerabilityScore:
        """Calculate comprehensive priority score for a vulnerability."""
        factors = {}

        # 1. CVSS Score (0-10)
        cvss_score = float(vuln.get("cvss_score") or vuln.get("nvd_data", {}).get("cvss_score") or 0)
        cvss_normalized = cvss_score / 10.0
        factors["cvss"] = cvss_score

        # 2. EPSS Score (exploit probability 0-1)
        epss_score = float(vuln.get("epss_score", 0))
        factors["epss"] = epss_score

        # 3. Exploit Availability (0-10)
        has_exploit = vuln.get("exploit_available", False) or len(vuln.get("exploits", [])) > 0
        exploit_score = 10.0 if has_exploit else 0.0
        exploit_normalized = exploit_score / 10.0
        factors["exploit_available"] = has_exploit

        # 4. Service Exposure (0-10)
        exposure_score = self._calculate_exposure(vuln, context)
        exposure_normalized = exposure_score / 10.0
        factors["service_exposure"] = exposure_score

        # 5. Vulnerability Age (0-10, newer = higher score)
        age_score = self._calculate_age_factor(vuln)
        age_normalized = age_score / 10.0
        factors["age_score"] = age_score

        # Calculate weighted priority score (0-100)
        priority_score = (
            (cvss_normalized * self.scoring_weights["cvss"]) +
            (epss_score * self.scoring_weights["epss"]) +
            (exploit_normalized * self.scoring_weights["exploit_available"]) +
            (exposure_normalized * self.scoring_weights["service_exposure"]) +
            (age_normalized * self.scoring_weights["age"])
        ) * 100

        # Determine risk level
        risk_level = self._determine_risk_level(priority_score, cvss_score, has_exploit)

        return VulnerabilityScore(
            cve_id=vuln.get("cve_id", "UNKNOWN"),
            base_score=cvss_score,
            exploitability_score=epss_score * 10,
            impact_score=self._calculate_impact_score(vuln),
            priority_score=priority_score,
            risk_level=risk_level,
            factors=factors,
        )

    def _calculate_exposure(self, vuln: Dict[str, Any], context: Optional[Dict[str, Any]]) -> float:
        """Calculate service exposure score (0-10)."""
        score = 5.0  # Default medium exposure

        # Check if service is internet-facing
        service_name = vuln.get("service", "").lower()
        port = vuln.get("port", 0)

        # High exposure services
        high_exposure = ["http", "https", "ssh", "ftp", "telnet", "smtp", "rdp"]
        if service_name in high_exposure or port in [80, 443, 22, 21, 23, 25, 3389]:
            score = 9.0

        # Check if publicly accessible
        host_ip = vuln.get("host", "")
        if context and host_ip:
            # Check if host is in public IP range
            if not host_ip.startswith(("10.", "172.16.", "192.168.")):
                score = min(score + 1.0, 10.0)

        return score

    def _calculate_age_factor(self, vuln: Dict[str, Any]) -> float:
        """Calculate age factor (newer vulnerabilities score higher)."""
        # Simplified: check if published date exists
        published = vuln.get("published") or vuln.get("nvd_data", {}).get("published")

        if not published:
            return 5.0  # Unknown age

        try:
            from datetime import datetime
            pub_date = datetime.fromisoformat(published.replace("Z", "+00:00"))
            age_days = (datetime.now() - pub_date.replace(tzinfo=None)).days

            # Score based on age
            if age_days < 30:
                return 10.0  # Very recent
            elif age_days < 90:
                return 8.0  # Recent
            elif age_days < 180:
                return 6.0  # Moderate
            elif age_days < 365:
                return 4.0  # Older
            else:
                return 2.0  # Old

        except Exception:
            return 5.0

    def _calculate_impact_score(self, vuln: Dict[str, Any]) -> float:
        """Calculate impact score (0-10) based on CVSS components."""
        cvss_score = float(vuln.get("cvss_score", 0))

        # Impact is roughly proportional to CVSS
        # High CVSS = high impact
        return cvss_score

    def _determine_risk_level(
        self,
        priority_score: float,
        cvss_score: float,
        has_exploit: bool
    ) -> RiskLevel:
        """Determine risk level based on multiple factors."""
        # Critical: High priority + high CVSS + exploit available
        if priority_score >= 80 and (cvss_score >= 9.0 or has_exploit):
            return RiskLevel.CRITICAL

        # High: High priority or (high CVSS + exploit)
        if priority_score >= 65 or (cvss_score >= 7.0 and has_exploit):
            return RiskLevel.HIGH

        # Medium: Moderate priority or moderate CVSS
        if priority_score >= 40 or cvss_score >= 4.0:
            return RiskLevel.MEDIUM

        # Low: Low priority
        if priority_score >= 20 or cvss_score >= 0.1:
            return RiskLevel.LOW

        return RiskLevel.INFO

    def generate_recommendations(
        self,
        vulnerabilities: List[Dict[str, Any]],
        max_recommendations: int = 10
    ) -> List[Dict[str, str]]:
        """Generate prioritized remediation recommendations."""
        recommendations = []

        # Get top vulnerabilities
        top_vulns = vulnerabilities[:max_recommendations]

        for idx, vuln in enumerate(top_vulns, 1):
            cve_id = vuln.get("cve_id", "UNKNOWN")
            description = vuln.get("description", "")[:150]
            severity = vuln.get("risk_level", "unknown")
            priority_score = vuln.get("priority_score", 0)

            recommendation = {
                "priority": idx,
                "cve_id": cve_id,
                "severity": severity,
                "score": f"{priority_score:.1f}",
                "action": self._generate_action(vuln),
                "rationale": self._generate_rationale(vuln),
            }

            recommendations.append(recommendation)

        return recommendations

    def _generate_action(self, vuln: Dict[str, Any]) -> str:
        """Generate remediation action for vulnerability."""
        cve_id = vuln.get("cve_id", "")
        service = vuln.get("service", "unknown service")

        actions = []

        # Check for exploit
        if vuln.get("exploit_available"):
            actions.append(f"Immediately patch {cve_id} - exploit is publicly available")

        # Check CVSS
        cvss = vuln.get("cvss_score", 0)
        if cvss >= 9.0:
            actions.append(f"Apply security update for {cve_id} urgently")
        elif cvss >= 7.0:
            actions.append(f"Schedule patching for {cve_id} within 7 days")

        # Service-specific actions
        if service in ["http", "https"]:
            actions.append("Review web application security configuration")
        elif service == "ssh":
            actions.append("Strengthen SSH configuration and key management")

        return actions[0] if actions else f"Review and remediate {cve_id}"

    def _generate_rationale(self, vuln: Dict[str, Any]) -> str:
        """Generate rationale for recommendation."""
        factors = []

        if vuln.get("exploit_available"):
            factors.append("exploit available")

        epss = vuln.get("epss_score", 0)
        if epss > 0.5:
            factors.append(f"high exploit probability ({epss:.1%})")

        cvss = vuln.get("cvss_score", 0)
        if cvss >= 9.0:
            factors.append("critical severity")
        elif cvss >= 7.0:
            factors.append("high severity")

        if not factors:
            return "Potential security risk"

        return "High risk due to: " + ", ".join(factors)

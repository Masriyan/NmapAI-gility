"""ExploitDB enricher plugin for exploit availability."""

import asyncio
from typing import Any, Dict, List, Optional
import aiohttp
import re

from nmapai.core.base_plugin import EnricherPlugin, PluginStatus


class ExploitDBEnricher(EnricherPlugin):
    """Enrich vulnerabilities with ExploitDB exploit information."""

    def __init__(self, config: Optional[Dict[str, Any]] = None):
        super().__init__(config)
        self.search_endpoint = "https://www.exploit-db.com/search"
        self.cache: Dict[str, List[Dict[str, Any]]] = {}

    @property
    def name(self) -> str:
        return "exploitdb_enricher"

    @property
    def version(self) -> str:
        return "2.0.0"

    async def validate(self) -> bool:
        """Validate ExploitDB is accessible."""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    "https://www.exploit-db.com",
                    timeout=aiohttp.ClientTimeout(total=10)
                ) as response:
                    return response.status == 200
        except Exception as e:
            self.error = f"ExploitDB not accessible: {e}"
            return False

    async def execute(self, context: Dict[str, Any]) -> Dict[str, Any]:
        """Execute ExploitDB enrichment."""
        self.status = PluginStatus.RUNNING

        try:
            vulnerabilities = context.get("vulnerabilities", [])

            if not vulnerabilities:
                self.status = PluginStatus.SKIPPED
                return {"vulnerabilities": []}

            enriched = await self.enrich(vulnerabilities)

            self.status = PluginStatus.COMPLETED
            self.results = {"vulnerabilities": enriched}
            self.metrics = {
                "total_vulns": len(vulnerabilities),
                "with_exploits": len([v for v in enriched if v.get("exploits")]),
            }

            return self.results

        except Exception as e:
            self.status = PluginStatus.FAILED
            self.error = str(e)
            raise

    async def enrich(self, vulnerabilities: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """Enrich vulnerabilities with exploit data."""
        for vuln in vulnerabilities:
            cve_id = vuln.get("cve_id") or vuln.get("id")

            if not cve_id or not cve_id.startswith("CVE-"):
                continue

            # Check cache
            if cve_id in self.cache:
                vuln["exploits"] = self.cache[cve_id]
                vuln["exploit_available"] = len(self.cache[cve_id]) > 0
                continue

            # Search ExploitDB
            try:
                exploits = await self._search_exploits(cve_id)
                self.cache[cve_id] = exploits

                vuln["exploits"] = exploits
                vuln["exploit_available"] = len(exploits) > 0

                # Rate limiting
                await asyncio.sleep(1.0)

            except Exception as e:
                print(f"Warning: Failed to search exploits for {cve_id}: {e}")
                continue

        return vulnerabilities

    async def _search_exploits(self, cve_id: str) -> List[Dict[str, Any]]:
        """Search for exploits in ExploitDB."""
        exploits = []

        try:
            # Use ExploitDB's JSON API
            params = {
                "cve": cve_id,
            }

            headers = {
                "User-Agent": "NmapAIGility/2.0"
            }

            async with aiohttp.ClientSession() as session:
                # Try JSON API endpoint
                async with session.get(
                    "https://www.exploit-db.com/search",
                    params=params,
                    headers=headers,
                    timeout=aiohttp.ClientTimeout(total=20)
                ) as response:
                    if response.status == 200:
                        try:
                            data = await response.json()

                            # Parse exploits from response
                            if isinstance(data, dict) and "data" in data:
                                for item in data.get("data", []):
                                    exploit = {
                                        "id": item.get("id"),
                                        "description": item.get("description", "")[:200],
                                        "type": item.get("type"),
                                        "platform": item.get("platform"),
                                        "date": item.get("date_published"),
                                        "url": f"https://www.exploit-db.com/exploits/{item.get('id')}",
                                    }
                                    exploits.append(exploit)

                        except Exception:
                            pass

        except Exception as e:
            print(f"Warning: ExploitDB search failed: {e}")

        return exploits[:5]  # Limit to top 5 exploits
